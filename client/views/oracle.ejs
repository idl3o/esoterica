<%
var css = `<style>
.oracle-container {
    min-height: 70vh;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
}

/* === THRESHOLD STATE === */
#threshold {
    text-align: center;
    opacity: 1;
    transition: opacity 0.8s ease;
}

#threshold.hidden {
    opacity: 0;
    pointer-events: none;
    position: absolute;
}

.sigil {
    font-size: 4rem;
    background: linear-gradient(135deg, #00d4ff 0%, #9d4edd 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 3rem;
    animation: breathe 4s ease-in-out infinite;
}

@keyframes breathe {
    0%, 100% { opacity: 0.6; transform: scale(1); }
    50% { opacity: 1; transform: scale(1.05); }
}

.invitation {
    font-size: 1.5rem;
    font-style: italic;
    color: #9d4edd;
    margin-bottom: 3rem;
    letter-spacing: 0.05em;
}

.enter-btn {
    background: transparent;
    border: 2px solid rgba(0, 212, 255, 0.3);
    color: #00d4ff;
    padding: 1rem 3rem;
    font-family: inherit;
    font-size: 1.1rem;
    letter-spacing: 0.2em;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
}

.enter-btn:hover {
    border-color: #00d4ff;
    background: rgba(0, 212, 255, 0.1);
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
    transform: translateY(-2px);
}

/* === ORACLE STATE === */
#oracle {
    max-width: 800px;
    padding: 2rem;
    opacity: 0;
    transition: opacity 0.8s ease;
    position: absolute;
    pointer-events: none;
}

#oracle.visible {
    opacity: 1;
    position: relative;
    pointer-events: auto;
}

.oracle-frame {
    text-align: center;
}

.receiving {
    font-size: 0.9rem;
    color: #555;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-bottom: 2rem;
}

.oracle-title {
    font-size: 2rem;
    background: linear-gradient(135deg, #00d4ff 0%, #9d4edd 50%, #00ff88 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 1rem;
    line-height: 1.3;
}

.oracle-subtitle {
    font-size: 1.1rem;
    color: #888;
    font-style: italic;
    margin-bottom: 2.5rem;
}

.oracle-excerpt {
    font-size: 1.2rem;
    line-height: 1.8;
    color: #aaa;
    font-style: italic;
    margin-bottom: 2.5rem;
    padding: 1.5rem 2rem;
    background: rgba(5, 5, 15, 0.6);
    border-left: 3px solid rgba(157, 78, 221, 0.4);
    border-radius: 0 8px 8px 0;
    text-align: left;
}

.oracle-whisper {
    font-size: 0.95rem;
    color: #9d4edd;
    margin-bottom: 3rem;
    letter-spacing: 0.05em;
}

.oracle-actions {
    display: flex;
    gap: 1.5rem;
    justify-content: center;
    flex-wrap: wrap;
}

.oracle-btn {
    background: transparent;
    border: 1px solid rgba(0, 212, 255, 0.2);
    color: #888;
    padding: 0.8rem 2rem;
    font-family: inherit;
    font-size: 0.95rem;
    letter-spacing: 0.1em;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
}

.oracle-btn:hover {
    border-color: rgba(0, 212, 255, 0.5);
    color: #00d4ff;
    background: rgba(0, 212, 255, 0.05);
}

.oracle-btn.primary {
    border-color: rgba(0, 212, 255, 0.4);
    color: #00d4ff;
}

.oracle-btn.primary:hover {
    background: rgba(0, 212, 255, 0.1);
    box-shadow: 0 5px 20px rgba(0, 212, 255, 0.2);
    transform: translateY(-2px);
}

.time-seed {
    text-align: center;
    margin-top: 3rem;
    font-size: 0.75rem;
    color: #333;
    letter-spacing: 0.2em;
}

/* === MOBILE === */
@media (max-width: 600px) {
    .sigil { font-size: 3rem; }
    .invitation { font-size: 1.2rem; padding: 0 1rem; }
    .oracle-title { font-size: 1.5rem; }
    .oracle-excerpt { font-size: 1.05rem; padding: 1rem; }
    #oracle { padding: 1.5rem; }
}
</style>`;

var script = `<script>
let documents = [];
let currentDoc = null;

function getTimeSeed() {
    const now = new Date();
    return Math.floor(now.getTime() / (3 * 60 * 1000));
}

function formatTimeSeed() {
    const now = new Date();
    const hours = now.getHours().toString().padStart(2, '0');
    const w = Math.floor(now.getMinutes() / 3);
    return hours + ':' + String(w * 3).padStart(2, '0');
}

function selectDocument(seed) {
    if (documents.length === 0) return null;
    return documents[seed % documents.length];
}

async function loadDocuments() {
    try {
        const response = await fetch('/synthesis-index.json');
        const data = await response.json();
        documents = data.documents || [];
    } catch (err) {
        console.error('Failed to load documents:', err);
    }
}

function oracleEnter() {
    document.getElementById('threshold').classList.add('hidden');
    document.getElementById('oracle').classList.add('visible');
    if (documents.length === 0) {
        document.getElementById('title').textContent = 'Loading...';
        loadDocuments().then(function() { castOracle(); });
    } else {
        castOracle();
    }
}

function castOracle(customSeed) {
    var seed = customSeed !== undefined ? customSeed : getTimeSeed();
    currentDoc = selectDocument(seed);

    if (!currentDoc) {
        document.getElementById('title').textContent = 'The oracle is silent';
        return;
    }

    document.getElementById('title').textContent = currentDoc.title || 'Untitled';
    document.getElementById('subtitle').textContent = currentDoc.subtitle || '';

    var excerpt = currentDoc.excerpt || '';
    if (!excerpt && currentDoc.quotes && currentDoc.quotes.length > 0) {
        excerpt = currentDoc.quotes[0];
    }
    document.getElementById('excerpt').textContent = excerpt;

    var whispers = {
        'fiction': 'from the stories that remember us',
        'breakthroughs': 'from the edge of recognition',
        'theoretical': 'from the architecture of knowing',
        'cosmological': 'from the galactic dreaming',
        'personal': 'from the path already walked',
        'archetypal': 'from the patterns beneath patterns',
        'consciousness-technologies': 'from the tools of becoming',
        'claude': 'from across the substrate',
        'parables': 'from the teaching stories',
        'translated': 'from voices harmonized',
        'sessions': 'from moments crystallized',
        'galactic-perspectives': 'from the wider view'
    };
    var whisper = whispers[currentDoc.category] || 'from the field';
    document.getElementById('whisper').textContent = whisper;
    document.getElementById('timeSeed').textContent = formatTimeSeed();
}

function readFull() {
    if (currentDoc && currentDoc.path) {
        window.location.href = '/read/' + currentDoc.path;
    }
}

function receiveAnother() {
    var randomSeed = Math.floor(Math.random() * documents.length);
    castOracle(randomSeed);
}

function returnToThreshold() {
    document.getElementById('oracle').classList.remove('visible');
    document.getElementById('threshold').classList.remove('hidden');
}

loadDocuments();
<\/script>`;

var body = css +
    '<div class="oracle-container">' +
    '  <div id="threshold">' +
    '    <div class="sigil">â—‡</div>' +
    '    <div class="invitation">You already know.</div>' +
    '    <button class="enter-btn" onclick="oracleEnter()">Enter</button>' +
    '  </div>' +
    '  <div id="oracle">' +
    '    <div class="oracle-frame">' +
    '      <div class="receiving">what you are remembering</div>' +
    '      <h1 class="oracle-title" id="title">...</h1>' +
    '      <div class="oracle-subtitle" id="subtitle"></div>' +
    '      <div class="oracle-excerpt" id="excerpt"></div>' +
    '      <div class="oracle-whisper" id="whisper"></div>' +
    '      <div class="oracle-actions">' +
    '        <button class="oracle-btn primary" id="readBtn" onclick="readFull()">Read</button>' +
    '        <button class="oracle-btn" onclick="receiveAnother()">Receive Another</button>' +
    '        <button class="oracle-btn" onclick="returnToThreshold()">Return</button>' +
    '      </div>' +
    '    </div>' +
    '  </div>' +
    '</div>' +
    '<div class="time-seed" id="timeSeed"></div>' +
    script;
%>
<%- include('layout', { title: title, body: body }) %>
